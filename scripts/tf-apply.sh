#!/bin/bash

# =============================================================================
# 테라폼 배포 스크립트 (Terraform Deployment Script)
# =============================================================================
# 이 스크립트는 CloudFront + Lambda@Edge + S3 정적 웹사이트를 배포합니다
# 
# 사용법: ./scripts/teraform.sh <ACCOUNT_ID> <AWS_PROFILE>
# 예시: ./scripts/teraform.sh 123456789012 my-aws-profile

# 스크립트 실행 시 전달받은 인자들을 변수에 저장
ACCOUNT_ID=$1        # 첫 번째 인자: AWS 계정 ID (예: 123456789012)
export AWS_PROFILE=$2 # 두 번째 인자: AWS 프로파일명 (예: default, my-profile)


# =============================================================================
# 1단계: Lambda@Edge 함수 패키징
# =============================================================================
# edge/ 폴더의 파일들을 edge.zip으로 압축
# Lambda@Edge는 반드시 zip 파일 형태로 배포해야 함
chmod +x ./scripts/package.sh
./scripts/package.sh

# =============================================================================
# 2단계: 테라폼 디렉토리로 이동
# =============================================================================
# tf/ 폴더로 이동하여 테라폼 명령어 실행
cd ./tf

# =============================================================================
# 3단계: 테라폼 초기화
# =============================================================================
# - AWS 프로바이더 다운로드
# - 로컬 상태 파일 초기화
# - 백엔드 설정
terraform init

# =============================================================================
# 4단계: 배포 계획 확인
# =============================================================================
# - 생성/수정/삭제할 리소스 목록 표시
# - 설정 오류나 문제점 미리 확인
# - 실제 배포 전 최종 점검
# - 기존 IAM 역할 ARN을 변수로 전달
terraform plan -var="lambda_exec_role_arn=arn:aws:iam::${ACCOUNT_ID}:role/lambda-exec"

# =============================================================================
# 5단계: 실제 배포 실행
# =============================================================================
# - AWS에 실제로 리소스 생성
# - -auto-approve: 사용자 확인 없이 자동 실행
# - 약 3-5분 소요 (CloudFront 배포 시간)
# - 기존 IAM 역할 ARN을 변수로 전달
terraform apply -auto-approve -var="lambda_exec_role_arn=arn:aws:iam::${ACCOUNT_ID}:role/lambda-exec"

